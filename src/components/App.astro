<ol
  class="m-5 grid grid-cols-5 divide-x-2 divide-y-2 divide-gray-500 text-center"
>
  <li class="col-span-2">
    <label>Communication control</label>
  </li>
  <li>
    <label>GPS coordinates:</label>
  </li>
  <li>
    <label>EET time:</label>
  </li>
  <li>
    <label>Satellite count:</label>
  </li>
  <li>
    <label for="select-port">Choose a port:</label>
  </li>
  <li>
    <button type="button" id="select-port" autofocus>Select</button>
  </li>
  <li class="row-span-3"><p id="coordinates">---</p></li>
  <li class="row-span-3"><p id="time">---</p></li>
  <li class="row-span-3"><p id="satellites">---</p></li>
  <li>
    <label for="select-baud-rate">Choose a baud rate:</label>
  </li>
  <li>
    <select id="select-baud-rate">
      <option value="912600">912600</option>
      <option value="115200">115200</option>
      <option value="9600">9600</option>
    </select>
  </li>
  <li class="col-span-2">
    <button type="button" id="connect-port">Connect port</button>
    <button type="button" id="save">Save</button>
    <button type="button" id="load">Load</button>
  </li>
  <li class="col-span-2 flex grow flex-col">
    <textarea
      readonly
      cols="70"
      rows="10"
      id="console"
      class="h-full overflow-hidden bg-gray-200 px-1 text-xs lg:text-sm xl:text-base 2xl:text-lg"
    ></textarea>
    <button type="button" id="clear-console">Clear console</button>
  </li>
  <li class="col-span-3">
    <canvas id="acceleration-chart"></canvas>
  </li>
  <li class="col-span-2">
    <div class="h-80" id="map">Map</div>
  </li>
  <li class="col-span-3">
    <canvas id="rotation-chart"></canvas>
  </li>
</ol>

<script>
  // Request serial port from user's browser
  let serial_port: SerialPort | null;
  const port_button = document.getElementById("select-port");
  port_button?.addEventListener("click", () => {
    navigator.serial
      .requestPort()
      .then((port) => {
        serial_port = port;
      })
      .catch((e) => {
        serial_port = null;
      });
  });

  // Configure and open serial port
  const connect_button = document.getElementById("connect-port");
  const baud_select = document.getElementById(
    "select-baud-rate",
  ) as HTMLInputElement;
  connect_button?.addEventListener("click", async () => {
    const baud_rate = Number(baud_select.value);
    if (serial_port) {
      await serial_port.open({ baudRate: baud_rate });
    }
    readPort();
  });

  // Read and buffer data from serial port
  async function readPort() {
    while (serial_port?.readable) {
      const decoder = new TextDecoderStream();
      serial_port?.readable.pipeTo(decoder.writable);
      const reader = decoder.readable.getReader();

      let buffer = "";
      try {
        while (serial_port) {
          const { value, done } = await reader.read();

          if (done) {
            break;
          }

          // Extract latest row of data from serial port
          // as Web Serial API gives discontinuous rows
          buffer += value;
          const rows = buffer.split("\r\n");
          buffer = rows.pop() || "";

          rows.forEach((row) => {
            if (row.trim().length === 0) return;
            printData(row);
            parseData(row);
          });
        }
      } catch (error) {
        console.error("Error reading serial port!");
      } finally {
        reader.releaseLock();
      }
    }
  }

  // Automatically select serial port on page load
  navigator.serial.getPorts().then((ports) => {
    serial_port = ports[0];
  });

  // Stop using serial port if it disconnects
  navigator.serial.addEventListener("disconnect", (e) => {
    if (e.target === serial_port) {
      serial_port = null;
      alert("Device disconnected!");
    }
  });

  // Extract GPS and sensor measurements from serial data row
  // and display latest measurements on page
  const coordinates = document.getElementById(
    "coordinates",
  ) as HTMLParagraphElement;
  const time = document.getElementById("time") as HTMLParagraphElement;
  const satellites = document.getElementById(
    "satellites",
  ) as HTMLParagraphElement;
  function parseData(data: String) {
    // Parse GPS data
    const parts = data.split(",");
    coordinates.innerText = parts[1] + "\r\n" + parts[2];
    time.innerText = parts[3];
    satellites.innerText = parts[4];

    // Update map
    marker.setLatLng([Number(parts[1]), Number(parts[2])]);
    map.setView(marker.getLatLng());

    // Parse accelerometer daa
    for (let i = 0; i < 3; i++) {
      acc_chart.data.datasets[i].data.shift();
      acc_chart.data.datasets[i].data.push(parts[5 + i]);
      acc_chart.update();
    }

    // Parse gyroscope data
    for (let i = 0; i < 3; i++) {
      rot_chart.data.datasets[i].data.shift();
      rot_chart.data.datasets[i].data.push(parts[8 + i]);
      rot_chart.update();
    }
  }

  // Print serial data rows to page
  const serial_console = document.getElementById("console") as HTMLInputElement;
  const serial_console_rows: String[] = [];
  function printData(data: String) {
    // Limit serial history to 50 rows
    if (serial_console_rows.length == 50) {
      serial_console_rows.shift();
    }
    serial_console_rows.push(data + "\r\n");

    // Sync rows with printed rows on page
    serial_console.textContent = "";
    serial_console_rows.forEach((row) => {
      serial_console.textContent += row;
    });
    serial_console.scrollTop = serial_console.scrollHeight;
  }

  // Clear printed serial data
  const clear_button = document.getElementById("clear-console");
  clear_button?.addEventListener("click", () => {
    serial_console.textContent = "";
    serial_console_rows.length = 0;
  });

  import Chart from "chart.js/auto";
  import { Colors } from "chart.js/auto";

  // Create chart for displaying measured acceleration
  const acc_chart_canvas = document.getElementById(
    "acceleration-chart",
  ) as HTMLCanvasElement;
  const acc_chart = new Chart(acc_chart_canvas, {
    type: "line",
    data: {
      labels: Array.from({ length: 20 }, (e, i) => -9.5 + i * 0.5),
      datasets: [
        {
          label: "X",
          data: new Array(20).fill(0),
          borderWidth: 1,
        },
        {
          label: "Y",
          data: new Array(20).fill(0),
          borderWidth: 1,
        },
        {
          label: "Z",
          data: new Array(20).fill(0),
          borderWidth: 1,
        },
      ],
    },
    options: {
      scales: {
        y: {
          title: {
            display: true,
            text: "Acceleration, g",
          },
          max: 4,
          min: -4,
        },
        x: {
          title: {
            display: true,
            text: "Time, s",
          },
        },
      },
      maintainAspectRatio: false,
    },
  });

  // Create chart for displaying measured rotation
  const rot_chart_canvas = document.getElementById(
    "rotation-chart",
  ) as HTMLCanvasElement;
  const rot_chart = new Chart(rot_chart_canvas, {
    type: "line",
    data: {
      labels: Array.from({ length: 20 }, (e, i) => -9.5 + i * 0.5),
      datasets: [
        {
          label: "X",
          data: new Array(20).fill(0),
          borderWidth: 1,
        },
        {
          label: "Y",
          data: new Array(20).fill(0),
          borderWidth: 1,
        },
        {
          label: "Z",
          data: new Array(20).fill(0),
          borderWidth: 1,
        },
      ],
    },
    options: {
      scales: {
        y: {
          title: {
            display: true,
            text: "Angular velocity, deg/s",
          },
          max: 500,
          min: -500,
        },
        x: {
          title: {
            display: true,
            text: "Time, s",
          },
        },
      },
      maintainAspectRatio: false,
    },
  });

  // Create map for displaying GPS coordinates
  import "leaflet/dist/leaflet.css";
  import "leaflet-defaulticon-compatibility/dist/leaflet-defaulticon-compatibility.css";
  import * as L from "leaflet";
  import "leaflet-defaulticon-compatibility";

  const map = L.map("map", {
    center: L.latLng(54.903801, 23.957818),
    zoom: 16,
  });

  L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution:
      '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
  }).addTo(map);

  const marker = L.marker(map.getCenter()).addTo(map);

  // Database functionality
  const load_button = document.getElementById("load") as HTMLButtonElement;
  load_button.addEventListener("click", () => {
    receiveData();

    const color = load_button.style.backgroundColor;
    load_button.style.backgroundColor = "green";
    load_button.disabled = true;

    setInterval(() => {
      load_button.style.backgroundColor = color;
      load_button.disabled = false;
    }, 5000);
  });

  function sendData(row: string) {
    const xhr = new XMLHttpRequest();
    const method = "POST";
    const url = "https://gpsdb.jects.lt/api.php";
    const username = "gps";
    const password = "gps password";

    xhr.open(method, url, true, username, password);
    xhr.setRequestHeader("Content-Type", "application/json");
    xhr.onreadystatechange = () => {
      if (xhr.readyState === XMLHttpRequest.DONE && xhr.status !== 200) {
        throw Error;
      }
    };

    const parts = row.split(",");
    const data = JSON.stringify({
      latitude: parts[1],
      longitude: parts[2],
      time: parts[3],
      satellites: parts[4],
      acceleration_x: parts[5],
      acceleration_y: parts[6],
      acceleration_z: parts[7],
      rotation_x: parts[8],
      rotation_y: parts[9],
      rotation_z: parts[10],
    });
    xhr.send(data);
  }

  function receiveData() {
    const xhr = new XMLHttpRequest();
    const method = "GET";
    const url = "https://gpsdb.jects.lt/api.php";
    const username = "gps";
    const password = "gps password";

    xhr.open(method, url, true, username, password);
    xhr.onload = () => {
      const json = JSON.parse(xhr.responseText);
      console.log(json);
    };
    xhr.send(null);
  }
</script>
